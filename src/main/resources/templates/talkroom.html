<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!--    대충 넣어봤습니다.-->
  <style>
    .myMessage {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      list-style: none;
    }
    .otherMessage{
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      list-style: none;
    }
  </style>

</head>
<body>
<div>
  <div>
    <h2><a href="/">home</a></h2>
    <h2>[[${room.location}]]</h2>
    <div id="userCount">
      [[${room.userCount}]]명 참여중
    </div>
  </div>

  <div>
<!--    임의로 style 아주 살짝 넣었습니다.-->
    <ul id="messageArea" style="height: auto; width: 100%; border:1px solid black; overflow:auto; width:1000px; height:500px;">

    </ul>
    <form id="messageForm" name="messageForm">
<!--      input의 style도 임의로 살짝 넣었습니다.-->
      <input type="text" id="message" placeholder="실시간 TALK에 참여해보세요" autocomplete="off" style="width:1000px; height: 20px; font-size:15px;">
      <button type="submit">Send</button>
    </form>
  </div>
</div>
</body>
</html>


<script th:inline="javascript">
  var messageArea = document.querySelector('#messageArea');
  var messageInput = document.querySelector('#message');
  var messageForm = document.querySelector('#messageForm');

  var roomLocation = [[${room.location}]];
  var userUUID = [[${userUUID}]];

  var stompClient = null;

  var userNickname = null;
  var userProfilePicture = null;

  var prevMessage = null;

  var page = 0;

  function connect(){
    //소켓연결
    var socket = new SockJS('/stomp/talk');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, onConnect, onError);

  }

  function onConnect(){
    // 소켓 연결후 실행될 로직들
    // 1. roomLocation을 이용하여 채팅방을 구독.
    stompClient.subscribe('/sub/talk/room/' + roomLocation, onMessageReceived);

    // 2. 입장 메세지 전송.
    stompClient.send("/pub/talk/enter",{},
            JSON.stringify({
              "location": roomLocation,
              "type": 'ENTER',
              "userUUID": userUUID
            })
    );

    //여기서 사용자 초기화. (userNickName, userProfilePicture)
    initUser();

    //여기서 이전기록들 불러오기.
    getTalkRecords(page++);
  }

  function onError(){
    //소켓 연결 실패시 실행되야 하는 로직.
    //상세한 이유는 TalkRoomController의 deleteUser 메서드 확인 바람
    $.ajax({
      type: 'post',
      url: 'talk/deleteUser',
      data: {location: roomLocation, userUUID: userUUID},
      dataType: 'json',
      success: function (){
        console.log("user delete");
      },
      error: function (error){
        console.error('user delete 실행실패', error);
      }
    })
    //여따가 에러메세지 띄우는거 추가하고싶음.
  }

  function onMessageReceived(payload){
    // 메세지를 받았을 때 처리하는 로직

    // chat의 꼴 (==message)
    // var chat={
    //     type,
    //     userUUID,
    //     location
    //     userNickname,
    //     userProfilePicture,
    //     content,
    //     date
    // };

    var chat = JSON.parse(payload.body);

    if(chat.type === 'TALK'){
      makeDateBar(chat);

      if (chat.userUUID === userUUID) {
        // 내 쪽에 채팅뜨게 뷰짜기.
        var myMessage = document.createElement('span');
        myMessage.classList.add('myMessage'); //css작업 필수
        myMessage.appendChild(viewMessage(chat));

        messageArea.appendChild(myMessage);
      } else {
        //상대방에 채팅뜨게 뷰짜기.
        var otherMessage = document.createElement('span');
        otherMessage.classList.add('otherMessage'); //css작업 필수
        otherMessage.appendChild(viewMessage(chat));

        messageArea.appendChild(otherMessage);
      }
    }else if(chat.type==='ENTER' || chat.type==='LEAVE'){
      // 입장 or 퇴장 메세지일 경우 ajax통신을 이용해 userCount를 갱신해주기
      updateUserCount();
    }
    messageArea.scrollTop = messageArea.scrollHeight;
  }

  function sendMessage(event){
    //메세지 보낼때 로직
    var messageContent = messageInput.value.trim();

    if (messageContent && stompClient) {
      var chat = {
        "type": 'TALK',
        "location": roomLocation,
        "userUUID": userUUID,
        "userNickname": userNickname,
        "userProfilePicture": userProfilePicture,
        "content": messageInput.value
      };

      stompClient.send("/pub/talk/sendMessage", {}, JSON.stringify(chat));
      messageInput.value = '';
    }
    event.preventDefault();
  }

  function makeDateBar(chat){
    // 가장 최근에 받은 메세지와 지금 받은 메세지의 날짜를 비교하여,
    // 날짜가 같으면 아무것도 안하고, 다를 경우 카카오톡처럼 날짜를 띄움.
    var currentDate = new Date(chat.date);
    var currentStringDate = String(currentDate.getFullYear()) + "년 "
            + String(currentDate.getMonth() + 1) + "월 " + String(currentDate.getDate()) + "일";

    if (prevMessage === null) {
      var dateBarElement = document.createElement('li');
      var dateElement = document.createElement('div');
      dateElement.appendChild(document.createTextNode(currentStringDate));
      dateBarElement.appendChild(dateElement);
      messageArea.appendChild(dateBarElement);
    } else {
      var prevDate = new Date(prevMessage.date);
      var prevStringDate = String(prevDate.getFullYear()) + "년 "
              + String(prevDate.getMonth() + 1) + "월 " + String(prevDate.getDate()) + "일";

      //직전에 받은 메세지의 date와 지금 받은 date의 년,월,일 비교.
      if (currentStringDate !== prevStringDate) {
        var dateBarElement = document.createElement('li');
        var dateElement = document.createElement('div');
        dateElement.appendChild(document.createTextNode(currentStringDate));
        dateBarElement.appendChild(dateElement);

          dateBarElement.classList.add('dateBarElement');

        messageArea.appendChild(dateBarElement);
      }
    }
    prevMessage = chat;
  }

  function viewMessage(chat) {
      // 받은 메세지(chat)을 뷰로 짜는 로직

      // var chat={
      //     type,
      //     userUUID,
      //     location
      //     userNickname,
      //     userProfilePicture,
      //     content,
      //     date
      // };

      var messageElement = document.createElement('li');
      var userElement = document.createElement('div');

      var userProfileElement = document.createElement('img');
      userProfileElement.setAttribute("src", chat.userProfilePicture);
      userProfileElement.setAttribute("width", "20");
      userProfileElement.setAttribute("height", "20");
      userProfileElement.classList.add('userProfileElement');

      var userNameElement = document.createElement('div');
      userNameElement.setAttribute("style", "display: inline");
      userNameElement.appendChild(document.createTextNode(chat.userNickname));
      userNameElement.classList.add('userNameElement');

      userElement.appendChild(userProfileElement);
      userElement.appendChild(userNameElement);

      var contentElement = document.createElement('div');
      contentElement.appendChild(document.createTextNode(chat.content));
      contentElement.classList.add('contentElement');

      var dateElement = document.createElement('div');
      dateElement.appendChild(document.createTextNode(dateToString(chat.date)));
      dateElement.classList.add('dateElement');

      messageElement.appendChild(userElement);
      messageElement.appendChild(contentElement);
      messageElement.appendChild(dateElement);

      return messageElement;
  }

  function dateToString(serverDate){
    // Date를 파싱하는 메서드

    var date = new Date(serverDate);

    var stringDate = null;
    if (date.getHours() < 12) {
      stringDate = "오전 " + String(date.getHours()) + ":" + String(date.getMinutes()).padStart(2, '0');
    }else if (date.getHours() === 12) {
      stringDate = "오후 " + String(date.getHours()) + ":" + String(date.getMinutes()).padStart(2, '0');
    }else{
      stringDate = "오후 " + String(date.getHours() - 12) + ":" + String(date.getMinutes()).padStart(2, '0');
    }
    return stringDate;
  }

  //실행.
  $(document).ready(function (){
    connect();
    messageForm.addEventListener('submit', sendMessage, false);
  });

  function updateUserCount(){
    // userCount를 갱신해주는 함수
    $.ajax({
      type: 'get',
      url: '/talk/userCount',
      data: {location: roomLocation},
      dataType: 'json',
      success: function (response) {
        document.getElementById('userCount').innerText = response.result.userCount + "명 참여중";
      },
      error: function (error) {
        console.error('getUserCount 에러', error);
      }
    });
  }

  function getTalkRecords(page){
    // page를 이용하여 이전 채팅 기록들을 DB로부터 가져오는 함수
    $.ajax({
      type: 'get',
      url: '/talk/getTalks',
      data: {page: page, location:roomLocation, userUUID: userUUID},
      dataType: 'json',
      success: function (response){
        console.log("getTalkRecords 성공");

        for(const chat of response.result) {

          if (chat.type === 'MINE') {
            makeDateBar(chat);
            //내 쪽에 채팅뜨게 뷰짜기.
            var myMessage = document.createElement('span');
            myMessage.classList.add('myMessage'); //css작업 필수
            myMessage.appendChild(viewMessage(chat));

            messageArea.appendChild(myMessage);
          } else if (chat.type === 'TALK') {
            makeDateBar(chat);
            //상대방에 채팅뜨게 뷰짜기.
            var otherMessage = document.createElement('span');
            otherMessage.classList.add('otherMessage'); //css작업 필수
            otherMessage.appendChild(viewMessage(chat));

            messageArea.appendChild(otherMessage);
          }
        }
        messageArea.scrollTop = messageArea.scrollHeight;
      },
      error: function (error){
        console.error('getTalkRecords 에러', error);
      }
    })
  }

  function initUser(){
    // 사용자 정보 초기화해주는 함수
    // 사용자의 닉네임과 프사를 DB로부터 불러와서 변수에 저장해줌
    $.ajax({
      type: 'get',
      url: '/talk/initUser',
      data: {location: roomLocation, userUUID: userUUID},
      dataType: 'json',
      success: function (response){
        userNickname = response.result.userNickname;
        userProfilePicture = response.result.userProfilePicture;
      },
      error: function (error){
        console.error('initUser 에러', error);
      }
    })
  }

</script>
